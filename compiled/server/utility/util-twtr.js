'use strict';

// Utility functions for pulling messages from twitter API
var request = require('request');
var axios = require('axios');
var twitterAccessTokens = require('../config/twitter.js');
var Promise = require('bluebird');

var twitterAPI = require('node-twitter-api');
var twitter = new twitterAPI({
  consumerKey: twitterAccessTokens['consumer_key'],
  consumerSecret: twitterAccessTokens['consumer_secret'],
  callback: 'http://127.0.0.1:3000/oauth'
});

// Promisify twitter-npm module functions for asynchronous use
// When multiargs === true must use spread function to receive multiple responses
var twtrGetReqTokenAsync = Promise.promisify(twitter.getRequestToken, { context: twitter, multiArgs: true });
var twtrGetAccessTokenAsync = Promise.promisify(twitter.getAccessToken, { context: twitter, multiArgs: true });
var twtrVerifyCredentialsAsync = Promise.promisify(twitter.verifyCredentials, { context: twitter, multiArgs: true });
var twtrGetTimelineAsync = Promise.promisify(twitter.getTimeline, { context: twitter, multiArgs: true });

module.exports = {
  getTweets: function getTweets(username, callback) {
    var accessToken = twitter.accessToken;
    var accessTokenSecret = twitter.accessTokenSecret;
    twtrGetTimelineAsync('user', { 'screen_name': username, count: 5 }, accessToken, accessTokenSecret).spread(function (data, response) {
      callback(null, data, response);
    }).catch(function (err) {
      console.error('Timeline retrieval error ', err);
      callback(err);
    });
  },

  getRequestToken: function getRequestToken(req, res) {

    twtrGetReqTokenAsync().spread(function (requestToken, requestTokenSecret, results) {
      // Save down request token / secret onto twitter object
      // In future would save down information within AuthO session if possible
      twitter['requestToken'] = requestToken;
      twitter['requestTokenSecret'] = requestTokenSecret;
      // Helper function from module to string together url we should redirect to in  order to receive verifier
      var url = twitter.getAuthUrl(requestToken);
      console.log('URL', url);
      // Redirecting to url above will ping twitter for a verifier, which will be sent to the callback
      // above as part of the querystring
      res.redirect(url);
    }).then(function (response) {
      console.log('REDIRECTION');
      res.status(200).end('successful redirection');
    }).catch(function (err) {
      console.error('Request Token Error');
    });
  },

  getAccessToken: function getAccessToken(req, res, oAuthVerifier) {
    // user oAuthVerifier from querystring to get access tokens
    var requestToken = twitter.requestToken;
    var requestTokenSecret = twitter.requestTokenSecret;

    twtrGetAccessTokenAsync(requestToken, requestTokenSecret, oAuthVerifier).spread(function (accessToken, accessTokenSecret, results) {
      // Save access tokens to twitter object
      // Would save these to session in future scenarios if possible
      twitter['accessToken'] = accessToken;
      twitter['accessTokenSecret'] = accessTokenSecret;
      // Verify twitter credentials have been accepted
      return twtrVerifyCredentialsAsync(accessToken, accessTokenSecret, results);
    }).spread(function (data, response) {
      // Check screen name of verified user
      console.log('SCREEN NAME: ', data['screen_name']);
      res.status(200).json(data);
    }).catch(function (err) {
      console.error('twitter request token error', err);
      res.status(404).end('Failed authentication');
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci91dGlsaXR5L3V0aWwtdHd0ci5qcyJdLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsImF4aW9zIiwidHdpdHRlckFjY2Vzc1Rva2VucyIsIlByb21pc2UiLCJ0d2l0dGVyQVBJIiwidHdpdHRlciIsImNvbnN1bWVyS2V5IiwiY29uc3VtZXJTZWNyZXQiLCJjYWxsYmFjayIsInR3dHJHZXRSZXFUb2tlbkFzeW5jIiwicHJvbWlzaWZ5IiwiZ2V0UmVxdWVzdFRva2VuIiwiY29udGV4dCIsIm11bHRpQXJncyIsInR3dHJHZXRBY2Nlc3NUb2tlbkFzeW5jIiwiZ2V0QWNjZXNzVG9rZW4iLCJ0d3RyVmVyaWZ5Q3JlZGVudGlhbHNBc3luYyIsInZlcmlmeUNyZWRlbnRpYWxzIiwidHd0ckdldFRpbWVsaW5lQXN5bmMiLCJnZXRUaW1lbGluZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJnZXRUd2VldHMiLCJ1c2VybmFtZSIsImFjY2Vzc1Rva2VuIiwiYWNjZXNzVG9rZW5TZWNyZXQiLCJjb3VudCIsInNwcmVhZCIsImRhdGEiLCJyZXNwb25zZSIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwicmVxIiwicmVzIiwicmVxdWVzdFRva2VuIiwicmVxdWVzdFRva2VuU2VjcmV0IiwicmVzdWx0cyIsInVybCIsImdldEF1dGhVcmwiLCJsb2ciLCJyZWRpcmVjdCIsInRoZW4iLCJzdGF0dXMiLCJlbmQiLCJvQXV0aFZlcmlmaWVyIiwianNvbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBLElBQUlBLFVBQVVDLFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSUMsUUFBUUQsUUFBUSxPQUFSLENBQVo7QUFDQSxJQUFJRSxzQkFBc0JGLFFBQVEsc0JBQVIsQ0FBMUI7QUFDQSxJQUFJRyxVQUFVSCxRQUFRLFVBQVIsQ0FBZDs7QUFFQSxJQUFJSSxhQUFhSixRQUFRLGtCQUFSLENBQWpCO0FBQ0EsSUFBSUssVUFBVSxJQUFJRCxVQUFKLENB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QUEvQjtBQUNBO0FBQ0EsYUFBT1QsMkJBQTJCUSxXQUEzQixFQUF3Q0MsaUJBQXhDLEVBQTJEYSxPQUEzRCxDQUFQO0FBQ0QsS0FSRCxFQVNDWCxNQVRELENBU1EsVUFBQ0MsSUFBRCxFQUFPQyxRQUFQLEVBQW9CO0FBQzFCO0FBQ0FHLGNBQVFTLEdBQVIsQ0FBWSxlQUFaLEVBQTZCYixLQUFLLGFBQUwsQ0FBN0I7QUFDQU8sVUFBSVMsTUFBSixDQUFXLEdBQVgsRUFBZ0JHLElBQWhCLENBQXFCbkIsSUFBckI7QUFDRCxLQWJELEVBY0NFLEtBZEQsQ0FjTyxVQUFDQyxHQUFELEVBQVM7QUFDZEMsY0FBUUMsS0FBUixDQUFjLDZCQUFkLEVBQTZDRixHQUE3QztBQUNBSSxVQUFJUyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsR0FBaEIsQ0FBb0IsdUJBQXBCO0FBQ0QsS0FqQkQ7QUFrQkQ7QUEvRGMsQ0FBakIiLCJmaWxlIjoidXRpbC10d3RyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVXRpbGl0eSBmdW5jdGlvbnMgZm9yIHB1bGxpbmcgbWVzc2FnZXMgZnJvbSB0d2l0dGVyIEFQSVxudmFyIHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG52YXIgYXhpb3MgPSByZXF1aXJlKCdheGlvcycpO1xudmFyIHR3aXR0ZXJBY2Nlc3NUb2tlbnMgPSByZXF1aXJlKCcuLi9jb25maWcvdHdpdHRlci5qcycpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuXG52YXIgdHdpdHRlckFQSSA9IHJlcXVpcmUoJ25vZGUtdHdpdHRlci1hcGknKTtcbnZhciB0d2l0dGVyID0gbmV3IHR3aXR0ZXJBUEkoe1xuICBjb25zdW1lcktleTogdHdpdHRlckFjY2Vzc1Rva2Vuc1snY29uc3VtZXJfa2V5J10sXG4gIGNvbnN1bWVyU2VjcmV0OiB0d2l0dGVyQWNjZXNzVG9rZW5zWydjb25zdW1lcl9zZWNyZXQnXSxcbiAgY2FsbGJhY2s6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvb2F1dGgnXG59KTtcblxuLy8gUHJvbWlzaWZ5IHR3aXR0ZXItbnBtIG1vZHVsZSBmdW5jdGlvbnMgZm9yIGFzeW5jaHJvbm91cyB1c2VcbiAgLy8gV2hlbiBtdWx0aWFyZ3MgPT09IHRydWUgbXVzdCB1c2Ugc3ByZWFkIGZ1bmN0aW9uIHRvIHJlY2VpdmUgbXVsdGlwbGUgcmVzcG9uc2VzXG52YXIgdHd0ckdldFJlcVRva2VuQXN5bmMgPSBQcm9taXNlLnByb21pc2lmeSh0d2l0dGVyLmdldFJlcXVlc3RUb2tlbiwge2NvbnRleHQ6IHR3aXR0ZXIsIG11bHRpQXJnczogdHJ1ZX0pO1xudmFyIHR3dHJHZXRBY2Nlc3NUb2tlbkFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkodHdpdHRlci5nZXRBY2Nlc3NUb2tlbiwge2NvbnRleHQ6IHR3aXR0ZXIsIG11bHRpQXJnczogdHJ1ZX0pO1xudmFyIHR3dHJWZXJpZnlDcmVkZW50aWFsc0FzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkodHdpdHRlci52ZXJpZnlDcmVkZW50aWFscywge2NvbnRleHQ6IHR3aXR0ZXIsIG11bHRpQXJnczogdHJ1ZX0pO1xudmFyIHR3dHJHZXRUaW1lbGluZUFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkodHdpdHRlci5nZXRUaW1lbGluZSwge2NvbnRleHQ6IHR3aXR0ZXIsIG11bHRpQXJnczogdHJ1ZX0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgZ2V0VHdlZXRzOiBmdW5jdGlvbih1c2VybmFtZSwgY2FsbGJhY2spIHtcbiAgICBsZXQgYWNjZXNzVG9rZW4gPSB0d2l0dGVyLmFjY2Vzc1Rva2VuO1xuICAgIGxldCBhY2Nlc3NUb2tlblNlY3JldCA9IHR3aXR0ZXIuYWNjZXNzVG9rZW5TZWNyZXQ7XG4gICAgdHd0ckdldFRpbWVsaW5lQXN5bmMoJ3VzZXInLCB7J3NjcmVlbl9uYW1lJzogdXNlcm5hbWUsIGNvdW50OiA1fSwgYWNjZXNzVG9rZW4sIGFjY2Vzc1Rva2VuU2VjcmV0KVxuICAgIC5zcHJlYWQoKGRhdGEsIHJlc3BvbnNlKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCBkYXRhLCByZXNwb25zZSk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcignVGltZWxpbmUgcmV0cmlldmFsIGVycm9yICcsIGVycik7XG4gICAgICBjYWxsYmFjayhlcnIpO1xuICAgIH0pO1xuICAgIFxuICB9LFxuXG4gIGdldFJlcXVlc3RUb2tlbjogZnVuY3Rpb24ocmVxLCByZXMpIHtcblxuICAgIHR3dHJHZXRSZXFUb2tlbkFzeW5jKClcbiAgICAuc3ByZWFkKChyZXF1ZXN0VG9rZW4sIHJlcXVlc3RUb2tlblNlY3JldCwgcmVzdWx0cykgPT4ge1xuICAgICAgLy8gU2F2ZSBkb3duIHJlcXVlc3QgdG9rZW4gLyBzZWNyZXQgb250byB0d2l0dGVyIG9iamVjdFxuICAgICAgICAvLyBJbiBmdXR1cmUgd291bGQgc2F2ZSBkb3duIGluZm9ybWF0aW9uIHdpdGhpbiBBdXRoTyBzZXNzaW9uIGlmIHBvc3NpYmxlXG4gICAgICB0d2l0dGVyWydyZXF1ZXN0VG9rZW4nXSA9IHJlcXVlc3RUb2tlbjtcbiAgICAgIHR3aXR0ZXJbJ3JlcXVlc3RUb2tlblNlY3JldCddID0gcmVxdWVzdFRva2VuU2VjcmV0O1xuICAgICAgLy8gSGVscGVyIGZ1bmN0aW9uIGZyb20gbW9kdWxlIHRvIHN0cmluZyB0b2dldGhlciB1cmwgd2Ugc2hvdWxkIHJlZGlyZWN0IHRvIGluICBvcmRlciB0byByZWNlaXZlIHZlcmlmaWVyXG4gICAgICBsZXQgdXJsID0gdHdpdHRlci5nZXRBdXRoVXJsKHJlcXVlc3RUb2tlbik7XG4gICAgICBjb25zb2xlLmxvZygnVVJMJywgdXJsKTtcbiAgICAgIC8vIFJlZGlyZWN0aW5nIHRvIHVybCBhYm92ZSB3aWxsIHBpbmcgdHdpdHRlciBmb3IgYSB2ZXJpZmllciwgd2hpY2ggd2lsbCBiZSBzZW50IHRvIHRoZSBjYWxsYmFja1xuICAgICAgLy8gYWJvdmUgYXMgcGFydCBvZiB0aGUgcXVlcnlzdHJpbmdcbiAgICAgIHJlcy5yZWRpcmVjdCh1cmwpO1xuICAgIH0pXG4gICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnUkVESVJFQ1RJT04nKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5lbmQoJ3N1Y2Nlc3NmdWwgcmVkaXJlY3Rpb24nKTtcbiAgICB9KVxuICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICBjb25zb2xlLmVycm9yKCdSZXF1ZXN0IFRva2VuIEVycm9yJyk7XG4gICAgfSk7XG5cbiAgfSxcblxuICBnZXRBY2Nlc3NUb2tlbjogZnVuY3Rpb24ocmVxLCByZXMsIG9BdXRoVmVyaWZpZXIpIHtcbiAgICAvLyB1c2VyIG9BdXRoVmVyaWZpZXIgZnJvbSBxdWVyeXN0cmluZyB0byBnZXQgYWNjZXNzIHRva2Vuc1xuICAgIGxldCByZXF1ZXN0VG9rZW4gPSB0d2l0dGVyLnJlcXVlc3RUb2tlbjtcbiAgICBsZXQgcmVxdWVzdFRva2VuU2VjcmV0ID0gdHdpdHRlci5yZXF1ZXN0VG9rZW5TZWNyZXQ7XG5cbiAgICB0d3RyR2V0QWNjZXNzVG9rZW5Bc3luYyhyZXF1ZXN0VG9rZW4sIHJlcXVlc3RUb2tlblNlY3JldCwgb0F1dGhWZXJpZmllcilcbiAgICAuc3ByZWFkKChhY2Nlc3NUb2tlbiwgYWNjZXNzVG9rZW5TZWNyZXQsIHJlc3VsdHMpID0+IHtcbiAgICAgIC8vIFNhdmUgYWNjZXNzIHRva2VucyB0byB0d2l0dGVyIG9iamVjdFxuICAgICAgICAvLyBXb3VsZCBzYXZlIHRoZXNlIHRvIHNlc3Npb24gaW4gZnV0dXJlIHNjZW5hcmlvcyBpZiBwb3NzaWJsZVxuICAgICAgdHdpdHRlclsnYWNjZXNzVG9rZW4nXSA9IGFjY2Vzc1Rva2VuO1xuICAgICAgdHdpdHRlclsnYWNjZXNzVG9rZW5TZWNyZXQnXSA9IGFjY2Vzc1Rva2VuU2VjcmV0O1xuICAgICAgLy8gVmVyaWZ5IHR3aXR0ZXIgY3JlZGVudGlhbHMgaGF2ZSBiZWVuIGFjY2VwdGVkXG4gICAgICByZXR1cm4gdHd0clZlcmlmeUNyZWRlbnRpYWxzQXN5bmMoYWNjZXNzVG9rZW4sIGFjY2Vzc1Rva2VuU2VjcmV0LCByZXN1bHRzKTtcbiAgICB9KVxuICAgIC5zcHJlYWQoKGRhdGEsIHJlc3BvbnNlKSA9PiB7XG4gICAgICAvLyBDaGVjayBzY3JlZW4gbmFtZSBvZiB2ZXJpZmllZCB1c2VyXG4gICAgICBjb25zb2xlLmxvZygnU0NSRUVOIE5BTUU6ICcsIGRhdGFbJ3NjcmVlbl9uYW1lJ10pO1xuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oZGF0YSk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcigndHdpdHRlciByZXF1ZXN0IHRva2VuIGVycm9yJywgZXJyKTtcbiAgICAgIHJlcy5zdGF0dXMoNDA0KS5lbmQoJ0ZhaWxlZCBhdXRoZW50aWNhdGlvbicpO1xuICAgIH0pO1xuICB9XG59OyJdfQ==